<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The New npm diff Command</title>
  <meta name="description" content="In a recent release, the npm CLI shipped a new command - npm diff - that&#39;s extremely useful for inspecting Node.js and JavaScript modules published to the npm registry. This is a relatively detailed primer on that command.">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/prism.ghcolors.css">
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="@bitandbang" />
<meta property="og:url" content="https://bnb.im/posts/the-new-npm-diff-command/" />
<meta property="og:title" content="The New npm diff Command" />
<meta property="og:description" content="In a recent release, the npm CLI shipped a new command - npm diff - that&#39;s extremely useful for inspecting Node.js and JavaScript modules published to the npm registry. This is a relatively detailed primer on that command." />
<meta name="twitter:image" content="https://bnb.im/img/small-card.png" />
<meta property="og:image" content="https://bnb.im/img/small-card.png" />


</head>
<body class="mono">
  <header class="global">
    <section class="container">
      <section class=grow-4>
        <a href="/"><h1>Tierney Cyren</h1></a>
      </section>
      <nav>
        <a href="https://twitter.com/bitandbang" class="p-l-1rem">Twitter</a>
        <a href="https://github.com/bnb" class="p-l-1rem">GitHub</a>
      </nav>
    </section>
  </header>
  <section>
    <section class="post container column">
  <h1 class="post-title">The New npm diff Command</h2>
  <sub>Originally posted on <time datetime="2021-04-02">02 Apr 2021</time>
</sub>
  <p>With the recent <a href="https://github.blog/2021-02-02-npm-7-is-now-generally-available/">release of npm@7</a>, we've gotten a few neat new features in npm.</p>
<p>One of the ones that I imagine can go under the radar for most folks is the <code>npm diff</code> command. It's a relatively... advanced command that has immense potential utility.</p>
<h2 id="preface" tabindex="-1">Preface <a class="direct-link" href="#preface" aria-hidden="true">#</a></h2>
<p>There's a few things we should establish as baseline assumptions before digging in.</p>
<p>First, I'm going to be talking about a &quot;local version&quot; and a &quot;remote version&quot;.</p>
<p>The local version will be a module in your current working directory - so, if I wanted to diff my local <code>liblice</code> module with the remote published version, I'd need to have that on disk and either have it as my current working directory or pass it as a path to the command. For the sake of this article, we're going to assume anytime we're diffing a local version it's in the current working directory.</p>
<p>The remote version will be one that's on your default registry. For the vast majority of folks, this will be the default npm registry (a.k.a. <a href="https://registry.npmjs.com">https://registry.npmjs.com</a>). However, if you're trying to diff a module published to an alternative registry (say, an internal corporate registry) or if you've changed your default registry to a mirror or internal cache, that would be the registry the remote version would be checking. This is some super nice flexibility that comes free with the diff command that enables some pretty nice theoretical advanced workflows.</p>
<h2 id="diffing-the-local-version-with-the-latest-remote-version" tabindex="-1">Diffing the Local Version with the Latest Remote Version <a class="direct-link" href="#diffing-the-local-version-with-the-latest-remote-version" aria-hidden="true">#</a></h2>
<p>The raw command will diff the local version of a module with the remote version. This is particularly useful for module maintainers, contributors, and those floating local patches on a module (to patch a security vulnerability, for example).</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">diff</span></code></pre>
<p>This will output <em>all</em> differences between the local version and the remote version. With a single change (replacing <code>pass</code> with <code>return</code>) in <a href="http://README.md">README.md</a> to use a better word, here's an example of what output would look like:</p>
<pre class="language-diff"><code class="language-diff">$ npm diff<br>diff --git a/README.md b/README.md<br>index v1.1.0..v1.1.0 100644<br><span class="token coord">--- a/README.md</span><br><span class="token coord">+++ b/README.md</span><br><span class="token coord">@@ -10,7 +10,7 @@</span><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"><br></span><span class="token prefix unchanged"> </span><span class="token line">## Usage<br></span><span class="token prefix unchanged"> </span><span class="token line"><br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">temporalts can pass all Node.js LTS release line temporal information, or the temporal information for a _specific_ release line.<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">temporalts can return all Node.js LTS release line temporal information, or the temporal information for a _specific_ release line.<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"><br></span><span class="token prefix unchanged"> </span><span class="token line">### `temporalts()`</code></pre>
<h2 id="diffing-individual-local-file(s)-with-the-latest-remote-version" tabindex="-1">Diffing Individual Local File(s) with the Latest Remote Version <a class="direct-link" href="#diffing-individual-local-file(s)-with-the-latest-remote-version" aria-hidden="true">#</a></h2>
<p>If you've made more than a single tiny change to your module, diffing a single file from the local version with the remote version.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># the general structure</span><br><span class="token function">npm</span> <span class="token function">diff</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.paths<span class="token punctuation">]</span><br><br><span class="token comment"># specific examples</span><br><span class="token function">npm</span> <span class="token function">diff</span> README.md<br><span class="token function">npm</span> <span class="token function">diff</span> /lib/handler.js<br><span class="token function">npm</span> <span class="token function">diff</span> SECURITY.md /public/index.html</code></pre>
<p>Instead of getting a diff for all files, you'll only get diffs for any paths you passed. If you passed a single path, you'll get a single diff; if you passed multiple, you'll get multiple.</p>
<p>This functionality can be <em>particularly</em> useful in a handful of cases: generating changelogs, checking how something works in the currently published version, or even as a prepublish check to make sure you're only shipping changes you intended to ship.</p>
<h2 id="diffing-local-version-with-a-specific-remote-version" tabindex="-1">Diffing Local Version with a Specific Remote Version <a class="direct-link" href="#diffing-local-version-with-a-specific-remote-version" aria-hidden="true">#</a></h2>
<p>Similar to <a href="#diffing-the-local-version-with-the-latest-remote-version">Diffing the Local Version with the Latest Remote Version</a>, you can diff your local version of a module with the remote version, but with any specific version.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>version<span class="token operator">></span></code></pre>
<p>As an example, here's an excerpt from running <code>npm diff --diff=1.0.1</code> on <a href="https://npm.im/temporalts">temporalts@1.1.0</a>. There's a single version between these two - v1.0.1 was <em>also</em> published, and we're able to compare what we <em>currently</em> have with a <em>previous</em> version that's not <code>@latest</code>. There's a few uses for this, like checking what's changed in a module while upgrading, changelog authoring, or pre-publish change validation (especially if you're using <code>files</code> in package.json to limit which files you're publishing).</p>
<p>We can also diff <em>forward</em> - for example, if I were to publish <code>temporalts@2.0.0</code>, I'd be able to diff between v1.1.0 and v2.0.0. This is useful, particularly if you're looking forward for upgrades or at pre-release versions.</p>
<pre class="language-diff"><code class="language-diff">$ npm diff --diff==1.0.0                                                                                <br>diff --git a/examples/12.js b/examples/12.js<br>deleted file mode 100644<br>index v1.0.0..v1.1.0 <br><span class="token coord">--- a/examples/12.js</span><br><span class="token coord">+++ b/examples/12.js</span><br><span class="token coord">@@ -1,12 +0,0 @@</span><br><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">const temporalts = require('../')<br></span><span class="token prefix deleted">-</span><span class="token line"><br></span><span class="token prefix deleted">-</span><span class="token line">async function prettyPrint () {<br></span><span class="token prefix deleted">-</span><span class="token line">  const version = 'v12'<br></span><span class="token prefix deleted">-</span><span class="token line">  const data = await temporalts(version)<br></span><span class="token prefix deleted">-</span><span class="token line"><br></span><span class="token prefix deleted">-</span><span class="token line">  console.log()<br></span><span class="token prefix deleted">-</span><span class="token line">  console.log(`We are ${data.currentPercentOfLTSLifeSpanWithoutDecimal}% through the lifespan of the Node.js ${version} LTS release line.\n${data.currentPercentOfLTSLifeSpanAsProgressBar} `)<br></span><span class="token prefix deleted">-</span><span class="token line">  console.log()<br></span><span class="token prefix deleted">-</span><span class="token line">}<br></span><span class="token prefix deleted">-</span><span class="token line"><br></span><span class="token prefix deleted">-</span><span class="token line">prettyPrint()<br></span></span>\ No newline at end of file<br>diff --git a/helpers/fetchSchedule.js b/helpers/fetchSchedule.js<br>index v1.0.0..v1.1.0 100644<br><span class="token coord">--- a/helpers/fetchSchedule.js</span><br><span class="token coord">+++ b/helpers/fetchSchedule.js</span><br><span class="token coord">@@ -12,4 +12,4 @@</span><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  }<br></span><span class="token prefix unchanged"> </span><span class="token line">}<br></span><span class="token prefix unchanged"> </span><span class="token line"><br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">module.exports = fetchSchedule<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">module.exports.fetchSchedule = fetchSchedule<br></span></span>diff --git a/index.js b/index.js<br>index v1.0.0..v1.1.0 100644<br><span class="token coord">--- a/index.js</span><br><span class="token coord">+++ b/index.js</span><br><span class="token coord">@@ -1,3 +1,3 @@</span><br><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">const lts = require('exports/lts.js')<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const lts = require('./exports/lts.js')<br></span></span><br>[... more file diffs, dropped for length]</code></pre>
<h2 id="diffing-individual-local-file(s)-with-a-specific-remote-version" tabindex="-1">Diffing Individual Local File(s) with a Specific Remote Version <a class="direct-link" href="#diffing-individual-local-file(s)-with-a-specific-remote-version" aria-hidden="true">#</a></h2>
<p>As an extension of <a href="">Diffing Local Version with a Specific Remote Version</a>, you can also pass in a single file to diff.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># the general structure</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>version<span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.paths<span class="token punctuation">]</span><br><br><span class="token comment"># specific examples</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>version<span class="token operator">></span> README.md<br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>version<span class="token operator">></span> /lib/handler.js<br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>version<span class="token operator">></span> SECURITY.md /public/index.html</code></pre>
<p>As an example, if we diff <code>index.js</code>:</p>
<pre class="language-diff"><code class="language-diff">$ npm diff --diff==1.0.0 index.js<br>diff --git a/index.js b/index.js<br>index v1.0.0..v1.1.0 100644<br><span class="token coord">--- a/index.js</span><br><span class="token coord">+++ b/index.js</span><br><span class="token coord">@@ -1,3 +1,3 @@</span><br><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">const lts = require('exports/lts.js')<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">const lts = require('./exports/lts.js')<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"><br></span><span class="token prefix unchanged"> </span><span class="token line">module.exports = lts</code></pre>
<h2 id="diffing-two-remote-versions" tabindex="-1">Diffing Two Remote Versions <a class="direct-link" href="#diffing-two-remote-versions" aria-hidden="true">#</a></h2>
<p>There is also a very valid reason you may want to diff two versions of the same module you've got that aren't locally stored. <code>npm diff</code> allows you to do this with package identifiers (a.k.a. <code>pkg-identifier</code>) which is something along the lines of <code>package@semver-range</code> - so, for example, <code>node@12.10.0</code>, <code>fastify@latest</code>, <code>babel@7.0.0-rc.1</code>, and <code>npm@7</code>.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># the general structure</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>pkg-identifier<span class="token operator">></span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>pkg-identifier<span class="token operator">></span><br><br><span class="token comment"># specific example</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span>gatsby@2.32.3 --diff<span class="token operator">=</span>gatsby@latest</code></pre>
<p>If we try to run the latter command - comparing a slightly older version of Gatsby to the latest version - we'll get about 19mb of diff output at time of publishing (the latest version of Gatsby is presently <code>gatsby@3.2.0</code> if you'd like to try to reproduce this output exactly). Unfortunately, that's far too much to include in a blog post, but you should try running it yourself.</p>
<p>As with any actively developed module - or any sufficiently modified module from one package identifier to another - this diff will only get bigger as the maintainers published newer and newer versions, making more changes.</p>
<h2 id="diffing-individual-files-from-two-remote-versions" tabindex="-1">Diffing Individual Files from Two Remote Versions <a class="direct-link" href="#diffing-individual-files-from-two-remote-versions" aria-hidden="true">#</a></h2>
<p>As with previous <code>npm diff</code> commands, you can pass in individual files or paths to filter your diff's output and you'll get just a diff for that file or path.</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># the general structure</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>pkg-identifier<span class="token operator">></span> --diff<span class="token operator">=</span><span class="token operator">&lt;</span>pkg-identifier<span class="token operator">></span><br><br><span class="token comment"># specific examples</span><br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span>fastify@3.13.0 --diff<span class="token operator">=</span>fastify@latest package.json<br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span>fastify@3.13.0 --diff<span class="token operator">=</span>fastify@latest /lib/errors.js<br><span class="token function">npm</span> <span class="token function">diff</span> --diff<span class="token operator">=</span>fastify@3.13.0 --diff<span class="token operator">=</span>fastify@latest README.md /lib/context.js</code></pre>
<p>Here's what the output for the first command there looks like:</p>
<pre class="language-diff"><code class="language-diff">$ npm diff --diff=fastify@3.13.0 --diff=fastify@latest package.json<br>diff --git a/package.json b/package.json<br>index v3.13.0..v3.14.1 100644<br><span class="token coord">--- a/package.json</span><br><span class="token coord">+++ b/package.json</span><br><span class="token coord">@@ -1,6 +1,6 @@</span><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">{<br></span><span class="token prefix unchanged"> </span><span class="token line">  "name": "fastify",<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  "version": "3.13.0",<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  "version": "3.14.1",<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  "description": "Fast and low overhead web framework, for Node.js",<br></span><span class="token prefix unchanged"> </span><span class="token line">  "main": "fastify.js",<br></span><span class="token prefix unchanged"> </span><span class="token line">  "type": "commonjs",<br></span></span><span class="token coord">@@ -177,7 +177,7 @@</span><br><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    "abstract-logging": "^2.0.0",<br></span><span class="token prefix unchanged"> </span><span class="token line">    "ajv": "^6.12.2",<br></span><span class="token prefix unchanged"> </span><span class="token line">    "avvio": "^7.1.2",<br></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    "fast-json-stringify": "^2.2.1",<br></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "fast-json-stringify": "^2.5.2",<br></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    "fastify-error": "^0.3.0",<br></span><span class="token prefix unchanged"> </span><span class="token line">    "fastify-warning": "^0.2.0",<br></span><span class="token prefix unchanged"> </span><span class="token line">    "find-my-way": "^4.0.0",</code></pre>
<h2 id="useful-flags" tabindex="-1">Useful Flags <a class="direct-link" href="#useful-flags" aria-hidden="true">#</a></h2>
<p>The <code>npm diff</code> command also provides some helpful flags to limit the diff output to only <em>relevant</em> changes, depending on your goal.</p>
<ul>
<li><code>--diff-ignore-all-space</code>: Ignores all changes that are exclusively space. Extremely useful for limiting changes to only what matters, especially after linter runs.</li>
<li><code>--diff-name-only</code>: Limits outputs to <em>only</em> filenames of files with changes for the command. Extremely useful for getting an overview of what's changed and figuring out which files to drill down into.</li>
</ul>

</section>
<section class="poke">
</section>
  </seciton>
  <footer></footer>
</body>
</html>